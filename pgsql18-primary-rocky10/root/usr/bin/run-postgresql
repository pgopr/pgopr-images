#!/bin/bash
#
# Eclipse Public License - v 2.0
#
# THE ACCOMPANYING PROGRAM IS PROVIDED UNDER THE TERMS OF THIS ECLIPSE
# PUBLIC LICENSE ("AGREEMENT"). ANY USE, REPRODUCTION OR DISTRIBUTION
# OF THE PROGRAM CONSTITUTES RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT.
#

NODE_EXPORTER_PIDFILE=/tmp/node_exporter.pid

function trap_sigterm() {
    kill -SIGINT $(head -1 $NODE_EXPORTER_PIDFILE)
}

trap 'trap_sigterm' SIGINT SIGTERM

if [ ! -f /pgdata/PG_VERSION ]; then
    export PG_MAX_CONNECTIONS=${PG_MAX_CONNECTIONS:-100}
    export PG_SHARED_BUFFERS=${PG_SHARED_BUFFERS:-256}
    export PG_WORK_MEM=${PG_WORK_MEM:-8}
    export PG_MAX_PARALLEL_WORKERS=${PG_MAX_PARALLEL_WORKERS:-8}
    export PG_EFFECTIVE_CACHE_SIZE=${PG_EFFECTIVE_CACHE_SIZE:-1}
    export PG_MAX_WAL_SIZE=${PG_MAX_WAL_SIZE:-1}
    export PG_PASSWORD_ENCRYPTION=${PG_PASSWORD_ENCRYPTION:-scram-sha-256}

    export PG_DATABASE=${PG_DATABASE}
    export PG_DATABASE_ENCODING=${PG_DATABASE_ENCODING:-UTF8}
    export PG_USER_NAME=${PG_USER_NAME}
    export PG_USER_PASSWORD=${PG_USER_PASSWORD}
    export PG_NETWORK_MASK=${PG_NETWORK_MASK}

    if [ -z "${PG_DATABASE}" ] ||
       [ -z "${PG_USER_NAME}" ] || [ -z "${PG_USER_PASSWORD}" ] ||
       [ -z "${PG_NETWORK_MASK}" ]; then
        echo "PG_DATABASE, PG_USER_NAME, PG_USER_PASSWORD and PG_NETWORK_MASK needs to be defined."
        exit 1
    fi
    
    /usr/pgsql-18/bin/initdb -k -X /pgwal/ -D /pgdata/ --locale-provider=icu --icu-locale=en-US

    sed -i "s|PG_MAX_CONNECTIONS|$PG_MAX_CONNECTIONS|g" /conf/postgresql.conf
    sed -i "s|PG_SHARED_BUFFERS|$PG_SHARED_BUFFERS|g" /conf/postgresql.conf
    sed -i "s|PG_WORK_MEM|$PG_WORK_MEM|g" /conf/postgresql.conf
    sed -i "s|PG_MAX_PARALLEL_WORKERS|$PG_MAX_PARALLEL_WORKERS|g" /conf/postgresql.conf
    sed -i "s|PG_EFFECTIVE_CACHE_SIZE|$PG_EFFECTIVE_CACHE_SIZE|g" /conf/postgresql.conf
    sed -i "s|PG_MAX_WAL_SIZE|$PG_MAX_WAL_SIZE|g" /conf/postgresql.conf
    sed -i "s|PG_PASSWORD_ENCRYPTION|$PG_PASSWORD_ENCRYPTION|g" /conf/postgresql.conf

    sed -i "s|PG_DATABASE|$PG_DATABASE|g" /conf/pg_hba.conf
    sed -i "s|PG_USER_NAME|$PG_USER_NAME|g" /conf/pg_hba.conf
    sed -i "s|PG_NETWORK_MASK|$PG_NETWORK_MASK|g" /conf/pg_hba.conf
    sed -i "s|PG_PASSWORD_ENCRYPTION|$PG_PASSWORD_ENCRYPTION|g" /conf/pg_hba.conf

    cp /conf/postgresql.conf /pgdata/
    cp /conf/pg_hba.conf /pgdata/

    sed -i "s|PG_DATABASE_ENCODING|$PG_DATABASE_ENCODING|g" /conf/setup.sql
    sed -i "s|PG_DATABASE|$PG_DATABASE|g" /conf/setup.sql
    sed -i "s|PG_USER_NAME|$PG_USER_NAME|g" /conf/setup.sql
    sed -i "s|PG_USER_PASSWORD|$PG_USER_PASSWORD|g" /conf/setup.sql

    /usr/pgsql-18/bin/pg_ctl -D /pgdata/ start
    /usr/pgsql-18/bin/psql -q -f /conf/setup.sql postgres
    /usr/pgsql-18/bin/pg_ctl -D /pgdata/ stop
fi

/usr/local/bin/node_exporter >> /tmp/node_exporter.log 2>&1 &
echo $! > $NODE_EXPORTER_PIDFILE

exec /usr/pgsql-18/bin/postgres -D /pgdata/ "$@"
